<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBC Service Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.20/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
        }
    }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Users, UserPlus, Search, Edit2, Trash2, Save, X, AlertCircle, 
            CheckCircle2, Clock, CalendarX, ShieldCheck, ChevronRight,
            Pin, Ban, Heart, Copy
        } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';

        // --- Supabase é€£ç·šè¨­å®š ---
        const SUPABASE_URL = "https://jcepavwocdujoeoqxvsd.supabase.co";
        const SUPABASE_KEY = "sb_publishable_Tj2n8e3yY1HyvaFzXRyO_w_PWrVFB7E"; 
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- é è¨­è³‡æ–™çµæ§‹ ---
        const DEFAULT_MEMBER = {
            name: '',
            preferred_session: 'ç¬¬ä¸€å ‚',
            availability_status: 'ç©©å®šæœäº‹',
            dual_service_pref: 0, // 0: ç„¡, 1: äºŒå ‚åŒå´—, 2: äºŒå ‚ç•°å´—
            group_id: '',
            unavailable_dates: [], 
            newcomer_rule: '' 
        };

        const SESSION_OPTIONS = ['ç¬¬ä¸€å ‚', 'ç¬¬äºŒå ‚', 'çš†å¯'];
        const STATUS_OPTIONS = ['ç©©å®šæœäº‹', 'æš«åœæœäº‹', 'å®‰æ¯å­£'];

        // --- è‡ªå‹•ç”¢ç”ŸåŸºç¤å­£åº¦æ¸…å–® ---
        const generateBaseQuarters = () => {
            const d = new Date();
            const currentYear = d.getFullYear();
            const currentQ = Math.floor(d.getMonth() / 3) + 1;
            const quarters = [];
            // ç”¢ç”Ÿã€Œæœ¬å­£ã€èˆ‡ã€Œä¸‹äºŒå­£ã€(å…±3å­£)
            for (let offset = 0; offset <= 2; offset++) {
                let q = currentQ + offset;
                let y = currentYear;
                if (q > 4) { q -= 4; y += 1; }
                quarters.push(`${y}-Q${q}`);
            }
            return quarters;
        };

        // --- è¨ˆç®—ä¸‹ä¸€å­£ ---
        const getNextQuarter = (qStr) => {
            let [y, q] = qStr.split('-Q').map(Number);
            if (q === 4) return `${y + 1}-Q1`;
            return `${y}-Q${q + 1}`;
        };

        const getCurrentQuarter = () => {
            const d = new Date();
            return `${d.getFullYear()}-Q${Math.floor(d.getMonth() / 3) + 1}`;
        };

        function App() {
            const [quarterOptions, setQuarterOptions] = useState(generateBaseQuarters());
            const [viewQuarter, setViewQuarter] = useState(getCurrentQuarter()); 
            
            const [members, setMembers] = useState([]);
            const [positions, setPositions] = useState([]);
            const [memberPositions, setMemberPositions] = useState([]);
            const [quarterSettings, setQuarterSettings] = useState([]);
            
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [message, setMessage] = useState({ type: '', text: '' });
            const [confirmAction, setConfirmAction] = useState(null);

            // åˆªé™¤å­£åº¦ç”¨çš„ç‹€æ…‹
            const [isDeleteQuarterModalOpen, setIsDeleteQuarterModalOpen] = useState(false);
            const [detectedQuarters, setDetectedQuarters] = useState([]);
            const [quarterToDelete, setQuarterToDelete] = useState('');

            const existingGroupIds = [...new Set(members.map(m => m.group_id).filter(Boolean))].sort();

            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMember, setEditingMember] = useState(null); 
            const [formData, setFormData] = useState({ ...DEFAULT_MEMBER });
            const [formPositions, setFormPositions] = useState({}); 
            const [newDateInput, setNewDateInput] = useState('');

            const loadData = async () => {
                setIsLoading(true);
                try {
                    // åŒæ™‚æŠ“å–æ‰€æœ‰è¨­å®šä¸­çš„å­£åº¦ï¼Œç¢ºä¿é¸å–®æ°¸é åŒ…å«è³‡æ–™åº«è£¡æœ‰çš„å­£åº¦
                    const { data: allSettingsQs } = await supabase.from('member_quarter_settings').select('quarter');
                    
                    const [
                        { data: mData },
                        { data: pData },
                        { data: mpData },
                        { data: qsData }
                    ] = await Promise.all([
                        supabase.from('members').select('*').order('name'),
                        supabase.from('positions').select('*').order('id'),
                        supabase.from('member_positions').select('*').eq('quarter', viewQuarter),
                        supabase.from('member_quarter_settings').select('*').eq('quarter', viewQuarter)
                    ]);

                    setMembers(mData || []);
                    setPositions(pData || []);
                    setMemberPositions(mpData || []);
                    setQuarterSettings(qsData || []);

                    // å‹•æ…‹æ›´æ–°å­£åº¦é¸å–®
                    if (allSettingsQs) {
                        const dbQuarters = allSettingsQs.map(d => d.quarter);
                        // ç§»é™¤ reverse() è®“é¸å–®ç…§æ™‚é–“å…ˆå¾Œ(æœ¬å­£ -> ä¸‹å­£ -> ä¸‹äºŒå­£)æ’åº
                        const combinedQs = [...new Set([...generateBaseQuarters(), ...dbQuarters, viewQuarter])].sort();
                        setQuarterOptions(combinedQs);
                    }
                } catch (err) {
                    showMessage('error', 'è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªé€£ç·šã€‚');
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { loadData(); }, [viewQuarter]);

            const showMessage = (type, text) => {
                setMessage({ type, text });
                setTimeout(() => setMessage({ type: '', text: '' }), 4000);
            };

            // ğŸŒŸ 1. å»ºç«‹ä¸‹å­£åŒå·¥è³‡æ–™ (æ–°å¢ç›®å‰ -> ä¸‹ä¸€å­£)
            const triggerCreateNextQuarter = () => {
                const targetQ = getNextQuarter(viewQuarter);
                setConfirmAction({
                    title: 'å»ºç«‹åŒå·¥è³‡æ–™',
                    message: `å®Œæ•´æ–°å¢ã€${viewQuarter}ã€‘åŒå·¥è³‡æ–™è‡³ã€${targetQ}ã€‘`,
                    confirmText: 'æ–°å¢',
                    onConfirm: () => executeCreateNextQuarter(viewQuarter, targetQ)
                });
            };

            const executeCreateNextQuarter = async (sourceQ, targetQ) => {
                setConfirmAction(null);
                setIsLoading(true);
                try {
                    const { data: oldSettings, error: err1 } = await supabase.from('member_quarter_settings').select('*').eq('quarter', sourceQ);
                    const { data: oldPos, error: err2 } = await supabase.from('member_positions').select('*').eq('quarter', sourceQ);

                    if (err1) throw err1;
                    if (err2) throw err2;

                    if ((!oldSettings || oldSettings.length === 0) && (!oldPos || oldPos.length === 0)) {
                        throw new Error(`ã€${sourceQ}ã€‘ç›®å‰æ²’æœ‰ä»»ä½•è³‡æ–™å¯ä¾›æ–°å¢ï¼`);
                    }

                    // åŠ å…¥è‡ªå‹•å»é‡æ©Ÿåˆ¶ (éæ¿¾ä¾†æºçš„é«’è³‡æ–™)
                    // ç¢ºä¿åŒä¸€å€‹ member_id åªæœ‰ä¸€ç­†è¨­å®šï¼Œé¿å…å¯«å…¥æ™‚é•å Unique Constraint
                    const uniqueSettingsMap = new Map();
                    if (oldSettings) {
                        oldSettings.forEach(s => uniqueSettingsMap.set(s.member_id, s));
                    }
                    const filteredOldSettings = Array.from(uniqueSettingsMap.values());

                    // ç¢ºä¿åŒä¸€å€‹ member_id + position_id åªæœ‰ä¸€ç­†è¨­å®š
                    const uniquePosMap = new Map();
                    if (oldPos) {
                        oldPos.forEach(p => uniquePosMap.set(`${p.member_id}_${p.position_id}`, p));
                    }
                    const filteredOldPos = Array.from(uniquePosMap.values());

                    // æ–°å¢å‰å…ˆå˜—è©¦æ¸…ç©ºç›®æ¨™å­£åº¦ï¼Œä¸¦æ•æ‰å¯èƒ½çš„éŒ¯èª¤ (é¿å…é»˜é»˜å¤±æ•—)
                    const { error: delErrSettings } = await supabase.from('member_quarter_settings').delete().eq('quarter', targetQ);
                    const { error: delErrPos } = await supabase.from('member_positions').delete().eq('quarter', targetQ);
                    
                    if (delErrSettings) console.warn("æ¸…ç©ºç›®æ¨™å­£åº¦è¨­å®šè­¦å‘Š:", delErrSettings);
                    if (delErrPos) console.warn("æ¸…ç©ºç›®æ¨™å­£åº¦è³‡æ ¼è­¦å‘Š:", delErrPos);

                    // å°‡ insert æ”¹ç‚º upsertï¼Œä¸¦åŠ ä¸Š onConflict æ¢ä»¶ï¼Œå¾¹åº•é¿é–‹ duplicate key å ±éŒ¯
                    if (filteredOldSettings.length > 0) {
                        const newSettings = filteredOldSettings.map(s => ({
                            member_id: s.member_id,
                            preferred_session: s.preferred_session,
                            availability_status: s.availability_status === 'å®‰æ¯å­£' ? 'ç©©å®šæœäº‹' : s.availability_status,
                            dual_service_pref: s.dual_service_pref,
                            newcomer_rule: s.newcomer_rule,
                            unavailable_dates: s.unavailable_dates,
                            quarter: targetQ
                        }));
                        const { error: insErr1 } = await supabase.from('member_quarter_settings').upsert(newSettings, { onConflict: 'member_id, quarter' });
                        if (insErr1) throw new Error("å¯«å…¥è¨­å®šå¤±æ•—: " + insErr1.message);
                    }

                    // æœäº‹è³‡æ ¼ä¹Ÿæ”¹ç”¨ upsertï¼Œç›´æ¥è¦†è“‹æ®˜ç•™çš„èˆŠè³‡æ–™
                    if (filteredOldPos.length > 0) {
                        const newPos = filteredOldPos.map(p => ({
                            member_id: p.member_id,
                            position_id: p.position_id,
                            is_active: p.is_active,
                            quarter: targetQ
                        }));
                        const { error: insErr2 } = await supabase.from('member_positions').upsert(newPos, { onConflict: 'member_id, position_id, quarter' });
                        if (insErr2) throw new Error("å¯«å…¥è³‡æ ¼å¤±æ•—: " + insErr2.message);
                    }
                    
                    showMessage('success', `å·²æˆåŠŸå»ºç«‹ ${targetQ} è³‡æ–™ï¼`);
                    setViewQuarter(targetQ); // è‡ªå‹•åˆ‡æ›ç•«é¢åˆ°å‰›å‰›å»ºç«‹å¥½çš„ä¸‹ä¸€å­£
                } catch (err) {
                    showMessage('error', 'å»ºç«‹å¤±æ•—: ' + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // ğŸŒŸ 2. åˆªé™¤ç‰¹å®šå­£åº¦è³‡æ–™
            const openDeleteQuarterModal = async () => {
                setIsLoading(true);
                try {
                    // è‡ªå‹•åµæ¸¬è³‡æ–™åº«ä¸­å­˜åœ¨å“ªäº›å­£åº¦
                    const { data: allSettingsQs } = await supabase.from('member_quarter_settings').select('quarter');
                    const { data: allPosQs } = await supabase.from('member_positions').select('quarter');
                    
                    const combined = [...(allSettingsQs || []), ...(allPosQs || [])].map(d => d.quarter);
                    const uniqueQs = [...new Set(combined)].sort().reverse();
                    
                    setDetectedQuarters(uniqueQs);
                    if (uniqueQs.length > 0) {
                        setQuarterToDelete(uniqueQs[0]);
                    } else {
                        setQuarterToDelete('');
                    }
                    setIsDeleteQuarterModalOpen(true);
                } catch (err) {
                    showMessage('error', 'ç„¡æ³•è¼‰å…¥ç¾æœ‰å­£åº¦æ¸…å–®');
                } finally {
                    setIsLoading(false);
                }
            };

            const executeDeleteQuarter = async () => {
                if (!quarterToDelete) return;
                setIsLoading(true);
                try {
                    // åŠ ä¸Š .select()ï¼Œè®“ Supabase å›å‚³å¯¦éš›è¢«åˆªé™¤çš„è³‡æ–™
                    // å¦‚æœ Supabase æ¬Šé™æ²’é–‹ï¼Œå®ƒä¸æœƒå ±éŒ¯ï¼Œä½†æœƒå›å‚³ç©ºé™£åˆ— (length === 0)
                    const { data: delSettings, error: err1 } = await supabase.from('member_quarter_settings').delete().eq('quarter', quarterToDelete).select();
                    const { data: delPos, error: err2 } = await supabase.from('member_positions').delete().eq('quarter', quarterToDelete).select();
                    
                    if (err1) throw err1;
                    if (err2) throw err2;
                    
                    // é˜²å‘†æª¢æŸ¥ï¼šå¦‚æœé¸å–®ä¸Šæœ‰é€™å€‹å­£åº¦ï¼Œä»£è¡¨çµ•å°æœ‰è³‡æ–™ã€‚è‹¥åˆªé™¤å¾Œå›å‚³ 0 ç­†ï¼Œçµ•å°æ˜¯æ¬Šé™è¢«æ“‹äº†ï¼
                    if ((!delSettings || delSettings.length === 0) && (!delPos || delPos.length === 0)) {
                        throw new Error("æœªèƒ½åˆªé™¤è³‡æ–™ï¼è«‹ç¢ºèª Supabase å¾Œå°å·²é—œé–‰ RLS æˆ–å·²é–‹å•Ÿ Delete æ¬Šé™ã€‚");
                    }
                    
                    showMessage('success', `å·²å¾¹åº•åˆªé™¤ ${quarterToDelete} çš„æ‰€æœ‰è³‡æ–™ï¼`);
                    setIsDeleteQuarterModalOpen(false);
                    
                    if (viewQuarter === quarterToDelete) {
                        loadData(); 
                    }
                } catch (err) {
                    showMessage('error', 'åˆªé™¤å¤±æ•—: ' + err.message);
                } finally {
                    setIsLoading(false);
                }
            };

            // --- åŒå·¥è³‡æ–™ Modal è™•ç† ---
            const openAddModal = () => {
                setEditingMember(null);
                setFormData({ ...DEFAULT_MEMBER });
                setFormPositions({});
                setIsModalOpen(true);
            };

            const openEditModal = (member) => {
                const settings = quarterSettings.find(s => s.member_id === member.id) || DEFAULT_MEMBER;
                
                let safeDates = [];
                if (Array.isArray(settings.unavailable_dates)) {
                    safeDates = settings.unavailable_dates;
                } else if (typeof settings.unavailable_dates === 'string') {
                    try { 
                        const parsed = JSON.parse(settings.unavailable_dates); 
                        safeDates = Array.isArray(parsed) ? parsed : [settings.unavailable_dates];
                    } catch(err) { 
                        safeDates = settings.unavailable_dates ? [settings.unavailable_dates] : []; 
                    }
                }

                setEditingMember(member);
                setFormData({ 
                    ...member, 
                    preferred_session: settings.preferred_session,
                    availability_status: settings.availability_status,
                    dual_service_pref: settings.dual_service_pref || 0,
                    unavailable_dates: safeDates,
                    newcomer_rule: settings.newcomer_rule === null ? '' : settings.newcomer_rule
                });
                
                const posMap = {};
                memberPositions
                    .filter(mp => mp.member_id === member.id)
                    .forEach(mp => {
                        posMap[mp.position_id] = mp.is_active !== false ? 'active' : 'inactive';
                    });
                setFormPositions(posMap);
                
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setEditingMember(null);
                setFormData({ ...DEFAULT_MEMBER });
                setNewDateInput('');
            };

            // æª¢æŸ¥æ˜¯å¦ç‚ºé€±æ—¥
            const handleDateChange = (e) => {
                const selectedDate = e.target.value;
                if (!selectedDate) {
                    setNewDateInput('');
                    return;
                }
                const dateObj = new Date(selectedDate);
                // getDay() å›å‚³ 0 ä»£è¡¨é€±æ—¥
                if (dateObj.getDay() !== 0) {
                    showMessage('error', 'åªèƒ½é¸æ“‡é€±æ—¥ï¼');
                    setNewDateInput(''); // æ¸…ç©ºéŒ¯èª¤çš„é¸æ“‡
                } else {
                    setNewDateInput(selectedDate);
                }
            };

            const addUnavailableDate = (e) => {
                if (e) e.preventDefault();
                if (!newDateInput) return showMessage('error', 'è«‹å…ˆé¸æ“‡ä¸€å€‹æ—¥æœŸï¼');

                let currentDates = Array.isArray(formData.unavailable_dates) ? formData.unavailable_dates : [];
                if (!currentDates.includes(newDateInput)) {
                    setFormData({ ...formData, unavailable_dates: [...currentDates, newDateInput].sort() });
                    setNewDateInput(''); 
                } else {
                    showMessage('error', 'é€™å€‹æ—¥æœŸå·²ç¶“åŠ å…¥å›‰ï¼');
                    setNewDateInput('');
                }
            };
            
            const removeUnavailableDate = (dateToRemove) => {
                let currentDates = Array.isArray(formData.unavailable_dates) ? formData.unavailable_dates : [];
                setFormData({ ...formData, unavailable_dates: currentDates.filter(d => d !== dateToRemove) });
            };

            const togglePosition = (posId) => {
                setFormPositions(prev => {
                    const currentStatus = prev[posId];
                    if (!currentStatus) return { ...prev, [posId]: 'active' };
                    if (currentStatus === 'active') return { ...prev, [posId]: 'inactive' };
                    const newState = { ...prev };
                    delete newState[posId];
                    return newState;
                });
            };

            const handleSave = async () => {
                if (!formData.name || !formData.name.trim()) return showMessage('error', 'å§“åä¸å¯ç‚ºç©ºï¼');
                
                setIsLoading(true);
                try {
                    let memberId = editingMember ? editingMember.id : null;
                    const cleanedGroupId = (formData.group_id || '').trim().toUpperCase();
                    const finalGroupId = cleanedGroupId === '' ? null : cleanedGroupId;
                    const parsedNewcomerRule = formData.newcomer_rule === '' ? null : parseInt(formData.newcomer_rule);

                    // 1. å¯«å…¥å…¨åŸŸè³‡æ–™è¡¨ (members)
                    const memberPayload = {
                        name: formData.name.trim(),
                        group_id: finalGroupId
                    };

                    if (memberId) {
                        await supabase.from('members').update(memberPayload).eq('id', memberId);
                    } else {
                        const { data, error } = await supabase.from('members').insert(memberPayload).select();
                        if (error) throw error;
                        memberId = data[0].id;
                    }

                    // 2. å¯«å…¥å­£åº¦è¨­å®šè¡¨ (member_quarter_settings)
                    await supabase.from('member_quarter_settings').upsert({
                        member_id: memberId,
                        quarter: viewQuarter,
                        preferred_session: formData.preferred_session,
                        availability_status: formData.availability_status,
                        dual_service_pref: parseInt(formData.dual_service_pref),
                        newcomer_rule: parsedNewcomerRule,
                        unavailable_dates: formData.unavailable_dates
                    }, { onConflict: 'member_id, quarter' });

                    // 3. å¯«å…¥å­£åº¦å´—ä½è¡¨ (member_positions)
                    if (memberId) {
                        await supabase.from('member_positions').delete().eq('member_id', memberId).eq('quarter', viewQuarter);
                        const posKeys = Object.keys(formPositions);
                        if (posKeys.length > 0) {
                            const insertPosPayload = posKeys.map(pid => ({ 
                                member_id: memberId, 
                                position_id: pid,
                                quarter: viewQuarter,
                                is_active: formPositions[pid] === 'active'
                            }));
                            await supabase.from('member_positions').insert(insertPosPayload);
                        }
                    }

                    showMessage('success', editingMember ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
                    closeModal();
                    loadData();
                } catch (err) {
                    showMessage('error', `å„²å­˜å¤±æ•—ï¼š${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleDelete = async (id, name) => {
                setConfirmAction({
                    title: 'åˆªé™¤åŒå·¥',
                    message: `ç¢ºå®šè¦åˆªé™¤åŒå·¥ã€Œ${name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šé€™æœƒé€£å¸¶æ°¸ä¹…åˆªé™¤ä»–ã€Œæ‰€æœ‰å­£åº¦ã€çš„ç´€éŒ„ï¼`,
                    confirmText: 'åˆªé™¤',
                    onConfirm: async () => {
                        setConfirmAction(null);
                        setIsLoading(true);
                        try {
                            // åŠ ä¸Š .select() ä¾†æª¢æŸ¥å–®ä¸€åŒå·¥æ˜¯å¦çœŸçš„è¢«åˆªé™¤äº†
                            const { data, error } = await supabase.from('members').delete().eq('id', id).select();
                            if (error) throw error;
                            
                            if (!data || data.length === 0) {
                                throw new Error("ç„¡æ¬Šé™åˆªé™¤ï¼è«‹ç¢ºèª Supabase å¾Œå°å·²é—œé–‰ members çš„ RLSã€‚");
                            }
                            
                            showMessage('success', 'å·²åˆªé™¤åŒå·¥è³‡æ–™ã€‚');
                            loadData();
                        } catch (err) {
                            showMessage('error', 'åˆªé™¤å¤±æ•—: ' + err.message);
                        } finally {
                            setIsLoading(false);
                        }
                    }
                });
            };

            let filteredMembers = members.filter(m => {
                const term = searchTerm.toLowerCase();
                if (m.name.toLowerCase().includes(term)) return true;
                if (m.group_id && m.group_id.toLowerCase().includes(term)) return true;
                const hasMatchingPosition = memberPositions
                    .filter(mp => mp.member_id === m.id)
                    .some(mp => {
                        const p = positions.find(pos => pos.id === mp.position_id);
                        return p && p.name.toLowerCase().includes(term);
                    });
                if (hasMatchingPosition) return true;
                return false;
            });

            filteredMembers.sort((a, b) => {
                const groupA = a.group_id || 'ZZZ_NO_GROUP'; 
                const groupB = b.group_id || 'ZZZ_NO_GROUP';
                if (groupA !== groupB) return groupA.localeCompare(groupB);
                
                const setA = quarterSettings.find(s => s.member_id === a.id) || {};
                const setB = quarterSettings.find(s => s.member_id === b.id) || {};
                const isTopA = (setA.newcomer_rule === 1 || setA.newcomer_rule === 3) ? -1 : 1;
                const isTopB = (setB.newcomer_rule === 1 || setB.newcomer_rule === 3) ? -1 : 1;
                if (isTopA !== isTopB) return isTopA - isTopB;
                
                return a.name.localeCompare(b.name);
            });

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    <nav className="bg-white sticky top-0 z-40 border-b border-slate-200 px-6 py-4 flex flex-col sm:flex-row justify-between items-center gap-4 shadow-sm">
                        <div className="flex items-center gap-3 w-full sm:w-auto justify-center sm:justify-start">
                            <div className="bg-indigo-600 p-2 rounded-xl text-white shadow-sm">
                                <Users size={24} />
                            </div>
                            <h1 className="text-xl font-black text-slate-800">TBC Service Manager</h1>
                        </div>
                        
                        <div className="flex items-center flex-wrap justify-center sm:justify-end gap-2 w-full sm:w-auto">
                            {/* å­£åº¦æª¢è¦–é¸å–® */}
                            <div className="flex items-center bg-slate-50 rounded-xl p-1.5 border border-slate-200">
                                <Clock size={16} className="ml-2 text-slate-400"/>
                                <select 
                                    value={viewQuarter} 
                                    onChange={(e) => setViewQuarter(e.target.value)}
                                    className="bg-transparent border-none px-3 py-1 font-bold text-indigo-600 outline-none cursor-pointer"
                                    title="åˆ‡æ›æª¢è¦–å­£åº¦"
                                >
                                    {quarterOptions.map(q => <option key={q} value={q}>{q}</option>)}
                                </select>
                            </div>
                            
                            {/* å»ºç«‹ä¸‹å­£æŒ‰éˆ• */}
                            <button onClick={triggerCreateNextQuarter} className="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-3 rounded-xl flex items-center gap-1.5 shadow-sm transition-all active:scale-95" title="ä»¥ç›®å‰å­£åº¦ç‚ºåŸºç¤ï¼Œæ–°å¢å»ºç«‹ä¸‹ä¸€å­£è³‡æ–™">
                                <Copy size={16} /> <span className="hidden md:inline">æ–°å¢</span>
                            </button>

                            {/* åˆªé™¤å­£åº¦æŒ‰éˆ• */}
                            <button onClick={openDeleteQuarterModal} className="bg-red-50 hover:bg-red-100 text-red-600 font-bold py-2 px-3 rounded-xl flex items-center gap-1.5 shadow-sm transition-all active:scale-95" title="åˆªé™¤ç‰¹å®šå­£åº¦çš„è³‡æ–™">
                                <Trash2 size={16} /> <span className="hidden md:inline">åˆªé™¤</span>
                            </button>

                            {/* æ–°å¢åŒå·¥æŒ‰éˆ• */}
                            <button onClick={openAddModal} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-xl flex items-center gap-1.5 shadow-sm transition-all active:scale-95 sm:ml-2" title="æ–°å¢ä¸€ä½åŒå·¥">
                                <UserPlus size={16} /> <span className="hidden md:inline">æ–°å¢åŒå·¥</span>
                            </button>
                        </div>
                    </nav>

                    {message.text && (
                        <div className={`fixed top-24 left-1/2 -translate-x-1/2 z-[80] px-6 py-3 rounded-full font-bold shadow-lg animate-fade-in flex items-center gap-2 ${message.type === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}`}>
                            {message.type === 'success' ? <CheckCircle2 size={18}/> : <AlertCircle size={18}/>}
                            {message.text}
                        </div>
                    )}

                    {/* é€šç”¨ç¢ºèªè¦–çª— */}
                    {confirmAction && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[70] flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-[2rem] shadow-2xl flex flex-col overflow-hidden">
                                <div className="p-8 text-center">
                                    <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-5 shadow-inner ${confirmAction.title === 'åˆªé™¤åŒå·¥' ? 'bg-red-100 text-red-500' : 'bg-amber-100 text-amber-500'}`}>
                                        <AlertCircle size={32} />
                                    </div>
                                    <h3 className="text-xl font-black text-slate-800 mb-3">{confirmAction.title}</h3>
                                    <p className="text-sm font-bold text-slate-500 whitespace-pre-line leading-relaxed">
                                        {confirmAction.message}
                                    </p>
                                </div>
                                <div className="p-4 bg-slate-50 flex gap-3 border-t border-slate-100">
                                    <button onClick={() => setConfirmAction(null)} className="flex-1 py-3.5 font-black text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors bg-white border border-slate-200 rounded-xl shadow-sm">
                                        å–æ¶ˆ
                                    </button>
                                    <button onClick={confirmAction.onConfirm} className={`flex-1 py-3.5 font-black text-white shadow-lg transition-all active:scale-95 rounded-xl ${confirmAction.title === 'åˆªé™¤åŒå·¥' ? 'bg-red-500 hover:bg-red-600 shadow-red-200' : 'bg-amber-500 hover:bg-amber-600 shadow-amber-200'}`}>
                                        {confirmAction.confirmText || 'ç¢ºå®šåŸ·è¡Œ'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* åˆªé™¤å­£åº¦å°ˆç”¨ Modal */}
                    {isDeleteQuarterModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[70] flex items-center justify-center p-4 animate-fade-in">
                            <div className="bg-white w-full max-w-md rounded-[2rem] shadow-2xl flex flex-col overflow-hidden">
                                <div className="p-8 text-center">
                                    <div className="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-5 shadow-inner bg-red-100 text-red-500">
                                        <Trash2 size={32} />
                                    </div>
                                    <h3 className="text-xl font-black text-slate-800 mb-3">åˆªé™¤åŒå·¥è³‡æ–™</h3>
                                    <p className="text-sm font-bold text-slate-500 mb-6 leading-relaxed">
                                        è«‹é¸æ“‡å­£åº¦ï¼Œæ°¸ä¹…åˆªé™¤ï¼Œ<span className="text-red-500">ç„¡æ³•å¾©åŸï¼</span>
                                    </p>
                                    <select 
                                        value={quarterToDelete} 
                                        onChange={(e) => setQuarterToDelete(e.target.value)}
                                        className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-red-500 focus:ring-2 focus:ring-red-100 font-bold text-slate-700 text-center cursor-pointer"
                                    >
                                        {detectedQuarters.length === 0 && <option value="">ç„¡è³‡æ–™å¯åˆªé™¤</option>}
                                        {detectedQuarters.map(q => <option key={q} value={q}>{q}</option>)}
                                    </select>
                                </div>
                                <div className="p-4 bg-slate-50 flex gap-3 border-t border-slate-100">
                                    <button onClick={() => setIsDeleteQuarterModalOpen(false)} className="flex-1 py-3.5 font-black text-slate-500 hover:text-slate-700 hover:bg-slate-100 transition-colors bg-white border border-slate-200 rounded-xl shadow-sm">
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        onClick={executeDeleteQuarter} 
                                        disabled={!quarterToDelete || isLoading}
                                        className="flex-1 py-3.5 font-black text-white bg-red-500 hover:bg-red-600 shadow-lg shadow-red-200 transition-all active:scale-95 rounded-xl disabled:opacity-50"
                                    >
                                        åˆªé™¤
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="flex-grow p-6 max-w-6xl mx-auto w-full">
                        <div className="bg-white p-2 rounded-2xl shadow-sm border border-slate-200 mb-6 flex items-center relative">
                            <Search className="absolute left-6 text-slate-400" size={20} />
                            <input 
                                type="text" 
                                placeholder="æœå°‹å§“åã€ç¾¤çµ„æˆ–å´—ä½ (ä¾‹å¦‚: æ‹›å¾…)..." 
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full pl-12 pr-4 py-3 bg-transparent outline-none font-bold text-slate-700"
                            />
                        </div>

                        {isLoading && members.length === 0 ? (
                            <div className="text-center py-20 text-slate-400 font-bold animate-pulse">è¼‰å…¥è³‡æ–™åº«ä¸­...</div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredMembers.map(member => {
                                    const settings = quarterSettings.find(s => s.member_id === member.id) || DEFAULT_MEMBER;
                                    const ownedPosList = memberPositions
                                        .filter(mp => mp.member_id === member.id)
                                        .map(mp => {
                                            const p = positions.find(pos => pos.id === mp.position_id);
                                            return p ? { name: p.name, isActive: mp.is_active !== false } : null;
                                        })
                                        .filter(Boolean);

                                    return (
                                        <div key={member.id} className="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="flex items-center gap-3">
                                                    <div>
                                                        <h3 className="text-xl font-black text-slate-800 flex items-center gap-2 flex-wrap">
                                                            {member.name}
                                                            {settings.dual_service_pref === 1 && <span className="text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded border border-purple-100">äºŒå ‚åŒå´—</span>}
                                                            {settings.dual_service_pref === 2 && <span className="text-[10px] bg-purple-50 text-purple-600 px-2 py-0.5 rounded border border-purple-100">äºŒå ‚ç•°å´—</span>}
                                                            {member.group_id && <span className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100">{member.group_id}</span>}
                                                        </h3>
                                                        <div className="flex items-center flex-wrap gap-1 text-xs font-bold mt-1.5">
                                                            <span className={settings.availability_status === 'ç©©å®šæœäº‹' ? 'text-emerald-500' : 'text-orange-500'}>â— {settings.availability_status}</span>
                                                            <span className="text-slate-300">|</span>
                                                            <span className="text-slate-500">{settings.preferred_session}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => openEditModal(member)} className="p-2 bg-slate-50 hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 rounded-lg transition-colors"><Edit2 size={16}/></button>
                                                    <button onClick={() => handleDelete(member.id, member.name)} className="p-2 bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-600 rounded-lg transition-colors"><Trash2 size={16}/></button>
                                                </div>
                                            </div>

                                            <div className="space-y-3">
                                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                    <p className="text-[10px] font-bold text-slate-400 mb-1 flex items-center gap-1"><ShieldCheck size={12}/> æœäº‹è³‡æ ¼ ({ownedPosList.length})</p>
                                                    <div className="flex flex-wrap gap-1.5">
                                                        {ownedPosList.length > 0 ? ownedPosList.map(p => (
                                                            <span key={p.name} className={`text-[10px] font-bold px-2 py-1 rounded-md border flex items-center gap-1 ${p.isActive ? 'bg-white border-slate-200 text-slate-600 shadow-sm' : 'bg-slate-50 border-slate-200 border-dashed text-slate-400'}`}>
                                                                {p.name} {!p.isActive && <span className="text-slate-400">(æš«åœ)</span>}
                                                                
                                                                {(p.name.includes('æ–°æœ‹å‹') && settings.newcomer_rule > 0) && (
                                                                    <span className="bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded border border-indigo-100">
                                                                        {settings.newcomer_rule === 1 && "ä¸»è²¬"}
                                                                        {settings.newcomer_rule === 2 && "ç¦æ’ç¬¬äºŒé€±"}
                                                                        {settings.newcomer_rule === 3 && "ä¸»è²¬ + ç¦æ’ç¬¬äºŒé€±"}
                                                                    </span>
                                                                )}
                                                            </span>
                                                        )) : <span className="text-xs text-slate-400">å°šæœªè¨­å®š</span>}
                                                    </div>
                                                </div>
                                                
                                                {(settings.unavailable_dates && settings.unavailable_dates.length > 0) && (
                                                    <div className="bg-orange-50/50 p-3 rounded-xl border border-orange-100">
                                                        <p className="text-[10px] font-bold text-orange-400 mb-1 flex items-center gap-1"><CalendarX size={12}/> ä¸å¯æ’ç­æ—¥ ({settings.unavailable_dates.length})</p>
                                                        <div className="flex flex-wrap gap-1">
                                                            {settings.unavailable_dates.map(d => (
                                                                <span key={d} className="text-[10px] font-bold bg-white text-orange-600 px-1.5 py-0.5 rounded border border-orange-200">{d}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        
                        {!isLoading && filteredMembers.length === 0 && (
                            <div className="text-center py-20 text-slate-400 font-bold">æ‰¾ä¸åˆ°ç¬¦åˆçš„åŒå·¥è³‡æ–™</div>
                        )}
                    </main>

                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in overflow-y-auto">
                            <div className="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden my-auto max-h-[90vh] flex flex-col">
                                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                                    <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                        {editingMember ? <Edit2 size={20} className="text-indigo-600"/> : <UserPlus size={20} className="text-indigo-600"/>}
                                        {editingMember ? 'ç·¨è¼¯åŒå·¥è³‡æ–™' : 'æ–°å¢åŒå·¥'} <span className="text-sm font-bold text-slate-400 ml-2">ç­åˆ¥({viewQuarter})</span>
                                    </h2>
                                    <button onClick={closeModal} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><X size={20}/></button>
                                </div>
                                
                                <div className="p-6 space-y-6 overflow-y-auto">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">å§“å <span className="text-red-500">*</span></label>
                                            <input 
                                                type="text" 
                                                value={formData.name} 
                                                onChange={e => setFormData({...formData, name: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700"
                                                placeholder="è«‹è¼¸å…¥å§“å"
                                            />
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">ç¾¤çµ„ ID<span className="text-slate-400 font-normal">(é¸å¡«)</span></label>
                                            <input 
                                                type="text" 
                                                value={formData.group_id} 
                                                onChange={e => setFormData({...formData, group_id: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 uppercase"
                                                placeholder="ä¾‹å¦‚ï¼šFAã€FB"
                                            />
                                            {existingGroupIds.length > 0 && (
                                                <p className="text-[10px] text-slate-400 font-semibold leading-relaxed">
                                                    ç¾æœ‰ç¾¤çµ„ï¼š<span className="text-indigo-400">{existingGroupIds.join(', ')}</span>
                                                </p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">æœäº‹æ„é¡˜</label>
                                            <select 
                                                value={formData.availability_status} 
                                                onChange={e => setFormData({...formData, availability_status: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 cursor-pointer"
                                            >
                                                {STATUS_OPTIONS.map(opt => (
                                                    <option key={opt} value={opt}>{opt}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                åŒæ—¥äºŒå ‚æœäº‹ <span className="text-slate-400 font-normal">(é¸å¡«)</span>
                                            </label>
                                            <select 
                                                value={formData.dual_service_pref} 
                                                onChange={e => setFormData({...formData, dual_service_pref: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 cursor-pointer"
                                            >
                                                <option value="0">ç„¡</option>
                                                <option value="1">äºŒå ‚åŒå´—</option>
                                                <option value="2">äºŒå ‚ç•°å´—</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">å ‚åˆ¥</label>
                                            <select 
                                                value={formData.preferred_session} 
                                                onChange={e => setFormData({...formData, preferred_session: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 cursor-pointer"
                                            >
                                                {SESSION_OPTIONS.map(opt => (
                                                    <option key={opt} value={opt}>{opt}</option>
                                                ))}
                                            </select>
                                        </div>

                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">
                                                æ–°æœ‹å‹é—œæ‡·è¨­å®š <span className="text-slate-400 font-normal">(é¸å¡«)</span>
                                            </label>
                                            <select 
                                                value={formData.newcomer_rule === null ? '' : formData.newcomer_rule} 
                                                onChange={e => setFormData({...formData, newcomer_rule: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 cursor-pointer"
                                            >
                                                <option value="">é è¨­(æ­£å¸¸æ’ç­)</option>
                                                <option value="1">ä¸»è²¬</option>
                                                <option value="2">ç¦æ’ç¬¬äºŒé€±</option>
                                                <option value="3">ä¸»è²¬ ï¼‹ ç¦æ’ç¬¬äºŒé€±</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="pt-4 border-t border-slate-100 col-span-1 md:col-span-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5 mb-1">
                                            <ShieldCheck size={16} className="text-indigo-500"/> æœäº‹å´—ä½è³‡æ ¼
                                        </label>
                                        <p className="text-[10px] text-slate-400 mb-3 ml-5">æç¤ºï¼šé€£çºŒé»æ“ŠæŒ‰éˆ•å¯åˆ‡æ›ã€Œæ­£å¸¸ã€æˆ–ã€Œæš«åœã€ç‹€æ…‹</p>
                                        <div className="flex flex-wrap gap-2">
                                            {positions.length === 0 && <span className="text-sm text-slate-400">ç³»çµ±å°šæœªå»ºç«‹å´—ä½è³‡æ–™ã€‚</span>}
                                            {positions.map(pos => {
                                                const status = formPositions[pos.id];
                                                
                                                let btnStyle = 'bg-slate-100 border-slate-100 text-slate-400 hover:bg-slate-200'; 
                                                if (status === 'active') btnStyle = 'bg-indigo-50 border-indigo-500 text-indigo-700 shadow-sm';
                                                else if (status === 'inactive') btnStyle = 'bg-white border-slate-400 text-slate-600 border-dashed shadow-sm';
                                                
                                                return (
                                                    <button
                                                        key={pos.id}
                                                        onClick={() => togglePosition(pos.id)}
                                                        className={`px-3 py-2 rounded-xl text-sm font-bold transition-all border-2 flex items-center gap-1.5 ${btnStyle}`}
                                                    >
                                                        {pos.name}
                                                        {status === 'active' && <span className="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded">æ­£å¸¸</span>}
                                                        {status === 'inactive' && <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">æš«åœ</span>}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    <div className="pt-4 border-t border-slate-100 pb-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5 mb-3">
                                            <CalendarX size={16} className="text-orange-500"/> ä¸å¯æ’ç­æ—¥
                                        </label>
                                        <div className="flex gap-2 mb-3">
                                            <input 
                                                type="date" 
                                                value={newDateInput} 
                                                onChange={handleDateChange} 
                                                className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 outline-none focus:border-orange-400 focus:ring-2 focus:ring-orange-100 transition-all font-semibold text-slate-700"
                                            />
                                            <button 
                                                type="button"
                                                onClick={addUnavailableDate} 
                                                className="bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold px-4 py-2.5 rounded-xl transition-colors active:scale-95"
                                            >
                                                åŠ å…¥æ—¥æœŸ
                                            </button>
                                        </div>
                                        
                                        <div className="flex flex-wrap gap-2">
                                            {(!formData.unavailable_dates || formData.unavailable_dates.length === 0) && <span className="text-sm text-slate-400">ç›®å‰ç„¡ä¸å¯æ’ç­ç´€éŒ„ã€‚</span>}
                                            {Array.isArray(formData.unavailable_dates) && formData.unavailable_dates.map(date => (
                                                <div key={date} className="bg-white border border-orange-200 text-orange-600 pl-3 pr-1 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                                                    {date}
                                                    <button 
                                                        type="button"
                                                        onClick={() => removeUnavailableDate(date)} 
                                                        className="p-1 hover:bg-orange-100 rounded-md text-orange-400 hover:text-orange-700 transition-colors"
                                                    >
                                                        <X size={14}/>
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                                    <button 
                                        onClick={closeModal} 
                                        className="px-5 py-2.5 rounded-xl font-bold text-slate-600 hover:bg-slate-200 transition-colors"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        onClick={handleSave} 
                                        disabled={isLoading} 
                                        className="bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-md transition-all active:scale-95"
                                    >
                                        <Save size={18}/> 
                                        {isLoading ? 'å„²å­˜ä¸­...' : 'å„²å­˜è¨­å®š'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
