<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBC Service Manager</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.20/babel.min.js"></script>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0?external=react,react-dom",
            "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@2"
        }
    }
    </script>
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Users, UserPlus, Search, Edit2, Trash2, Save, X, AlertCircle, 
            CheckCircle2, Clock, CalendarX, ShieldCheck, ChevronRight 
        } from 'lucide-react';
        import { createClient } from '@supabase/supabase-js';

        // --- Supabase é€£ç·šè¨­å®š ---
        const SUPABASE_URL = "https://jcepavwocdujoeoqxvsd.supabase.co";
        const SUPABASE_KEY = "sb_publishable_Tj2n8e3yY1HyvaFzXRyO_w_PWrVFB7E"; 
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- é è¨­è³‡æ–™çµæ§‹ ---
        const DEFAULT_MEMBER = {
            name: '',
            preferred_session: 'çš†å¯',
            availability_status: 'ç©©å®šæœäº‹',
            dual_service_pref: 0, // 0: ç„¡, 1: åŒå´—ä½, 2: ä¸åŒå´—ä½
            group_id: '',
            unavailable_dates: [] // array of strings (YYYY-MM-DD)
        };

        const SESSION_OPTIONS = ['ç¬¬ä¸€å ‚', 'ç¬¬äºŒå ‚', 'çš†å¯'];
        const STATUS_OPTIONS = ['ç©©å®šæœäº‹', 'æš«åœæœäº‹', 'å®‰æ¯å­£'];

        function App() {
            const [members, setMembers] = useState([]);
            const [positions, setPositions] = useState([]);
            const [memberPositions, setMemberPositions] = useState([]);
            
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [message, setMessage] = useState({ type: '', text: '' });

            // å–å¾—ç›®å‰å·²å­˜åœ¨çš„æ‰€æœ‰ä¸é‡è¤‡ç¾¤çµ„ ID
            const existingGroupIds = [...new Set(members.map(m => m.group_id).filter(Boolean))].sort();

            // Modal ç‹€æ…‹
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingMember, setEditingMember] = useState(null); // null è¡¨ç¤ºæ–°å¢
            const [formData, setFormData] = useState({ ...DEFAULT_MEMBER });
            const [formPositions, setFormPositions] = useState({}); // { [posId]: 'active' | 'inactive' }
            const [newDateInput, setNewDateInput] = useState('');

            // 1. è¼‰å…¥è³‡æ–™åº«
            const loadData = async () => {
                setIsLoading(true);
                try {
                    const [
                        { data: membersData, error: mErr },
                        { data: positionsData, error: pErr },
                        { data: memberPosData, error: mpErr }
                    ] = await Promise.all([
                        supabase.from('members').select('*').order('name'),
                        supabase.from('positions').select('*').order('id'),
                        supabase.from('member_positions').select('*')
                    ]);

                    if (mErr) throw mErr;
                    if (pErr) throw pErr;
                    if (mpErr) throw mpErr;

                    setMembers(membersData || []);
                    setPositions(positionsData || []);
                    setMemberPositions(memberPosData || []);
                } catch (err) {
                    console.error(err);
                    showMessage('error', 'è¼‰å…¥è³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªé€£ç·šæˆ–ç„¡è³‡æ–™è¡¨ã€‚');
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            const showMessage = (type, text) => {
                setMessage({ type, text });
                setTimeout(() => setMessage({ type: '', text: '' }), 3000);
            };

            // 2. è¡¨å–®è™•ç† (é–‹å•Ÿæ–°å¢/ç·¨è¼¯)
            const openAddModal = () => {
                setEditingMember(null);
                setFormData({ ...DEFAULT_MEMBER });
                setFormPositions({});
                setIsModalOpen(true);
            };

            const openEditModal = (member) => {
                setEditingMember(member);
                setFormData({ ...member, unavailable_dates: member.unavailable_dates || [] });
                
                // æ‰¾å‡ºè©²åŒå·¥æ“æœ‰çš„å´—ä½ ID èˆ‡æ’ç­ç‹€æ…‹
                const posMap = {};
                memberPositions
                    .filter(mp => mp.member_id === member.id)
                    .forEach(mp => {
                        // å¦‚æœèˆŠè³‡æ–™æ²’æœ‰ is_active æ¬„ä½ï¼Œé è¨­è¦–ç‚º active
                        posMap[mp.position_id] = mp.is_active !== false ? 'active' : 'inactive';
                    });
                setFormPositions(posMap);
                
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setEditingMember(null);
                setFormData({ ...DEFAULT_MEMBER });
                setNewDateInput('');
            };

            // è™•ç†è«‹å‡æ—¥æœŸ
            const addUnavailableDate = () => {
                if (newDateInput && !formData.unavailable_dates.includes(newDateInput)) {
                    setFormData({ ...formData, unavailable_dates: [...formData.unavailable_dates, newDateInput].sort() });
                    setNewDateInput('');
                }
            };
            const removeUnavailableDate = (dateToRemove) => {
                setFormData({ ...formData, unavailable_dates: formData.unavailable_dates.filter(d => d !== dateToRemove) });
            };

            // è™•ç†å´—ä½åˆ‡æ› (ä¸‰æ®µå¼ï¼šæœªé¸ -> æ­£å¸¸ -> æš«åœ -> æœªé¸)
            const togglePosition = (posId) => {
                setFormPositions(prev => {
                    const currentStatus = prev[posId];
                    if (!currentStatus) return { ...prev, [posId]: 'active' };
                    if (currentStatus === 'active') return { ...prev, [posId]: 'inactive' };
                    const newState = { ...prev };
                    delete newState[posId];
                    return newState;
                });
            };

            // 3. å„²å­˜è‡³è³‡æ–™åº« (æ–°å¢æˆ–æ›´æ–°)
            const handleSave = async () => {
                if (!formData.name || !formData.name.trim()) return showMessage('error', 'å§“åä¸å¯ç‚ºç©ºï¼');
                
                setIsLoading(true);
                try {
                    let memberId = editingMember ? editingMember.id : null;

                    // è™•ç†ç¾¤çµ„ IDï¼šå¦‚æœæ˜¯ç©ºç™½ï¼Œå¿…é ˆè½‰æˆ nullï¼Œå¦å‰‡æœƒè§¸ç™¼ Foreign Key éŒ¯èª¤
                    const cleanedGroupId = (formData.group_id || '').trim().toUpperCase();
                    const finalGroupId = cleanedGroupId === '' ? null : cleanedGroupId;

                    // æ­¥é©Ÿ A: è™•ç† members è¡¨
                    const memberPayload = {
                        name: formData.name.trim(),
                        preferred_session: formData.preferred_session,
                        availability_status: formData.availability_status,
                        dual_service_pref: parseInt(formData.dual_service_pref),
                        group_id: finalGroupId,
                        unavailable_dates: formData.unavailable_dates || []
                    };

                    if (memberId) {
                        // æ›´æ–°
                        const { error } = await supabase.from('members').update(memberPayload).eq('id', memberId);
                        if (error) throw error;
                    } else {
                        // æ–°å¢
                        const { data, error } = await supabase.from('members').insert(memberPayload).select();
                        if (error) throw error;
                        
                        // é˜²è­·ï¼šå¦‚æœ RLS æœ‰å•é¡Œå¯èƒ½æ‹¿ä¸åˆ°å›å‚³çš„ data
                        if (!data || data.length === 0) {
                            throw new Error("ç„¡æ³•å–å¾—æ–°å¢çš„è³‡æ–™ï¼Œè«‹æª¢æŸ¥ Supabase çš„ Select æ¬Šé™");
                        }
                        memberId = data[0].id;
                    }

                    // æ­¥é©Ÿ B: è™•ç† member_positions é—œè¯è¡¨ (å…¨åˆªé™¤å¾Œé‡å»º)
                    if (memberId) {
                        const { error: delErr } = await supabase.from('member_positions').delete().eq('member_id', memberId);
                        if (delErr && delErr.code !== 'PGRST116') console.warn('Delete old positions issue:', delErr);

                        const posKeys = Object.keys(formPositions);
                        if (posKeys.length > 0) {
                            const insertPosPayload = posKeys.map(pid => ({ 
                                member_id: memberId, 
                                position_id: pid, // ğŸŒŸ å·²ç¶“ç§»é™¤ parseInt()ï¼Œç›´æ¥å‚³å…¥ uuid å­—ä¸²
                                is_active: formPositions[pid] === 'active'
                            }));
                            const { error: insErr } = await supabase.from('member_positions').insert(insertPosPayload);
                            if (insErr) throw insErr;
                        }
                    }

                    showMessage('success', editingMember ? 'æ›´æ–°æˆåŠŸï¼' : 'æ–°å¢æˆåŠŸï¼');
                    closeModal();
                    loadData(); // é‡æ–°æ•´ç†åˆ—è¡¨
                } catch (err) {
                    console.error("å„²å­˜ç™¼ç”ŸéŒ¯èª¤:", err);
                    // ç¢ºä¿éŒ¯èª¤è¨Šæ¯èƒ½è¢«ä½¿ç”¨è€…çœ‹è¦‹
                    showMessage('error', `å„²å­˜å¤±æ•—ï¼š${err.message || 'è«‹æª¢æŸ¥æ¬Šé™è¨­å®š'}`);
                } finally {
                    setIsLoading(false);
                }
            };

            // 4. åˆªé™¤åŒå·¥
            const handleDelete = async (id, name) => {
                if (!window.confirm(`ç¢ºå®šè¦åˆªé™¤åŒå·¥ã€Œ${name}ã€å—ï¼Ÿ\næ³¨æ„ï¼šé€™æœƒé€£å¸¶åˆªé™¤ä»–æ‰€æœ‰çš„æ’ç­ç´€éŒ„ï¼`)) return;
                
                setIsLoading(true);
                try {
                    const { error } = await supabase.from('members').delete().eq('id', id);
                    if (error) throw error;
                    showMessage('success', 'å·²åˆªé™¤åŒå·¥è³‡æ–™ã€‚');
                    loadData();
                } catch (err) {
                    console.error(err);
                    showMessage('error', 'åˆªé™¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚');
                } finally {
                    setIsLoading(false);
                }
            };

            // éæ¿¾æœå°‹
            const filteredMembers = members.filter(m => 
                m.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (m.group_id && m.group_id.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col">
                    {/* é ‚éƒ¨å°è¦½åˆ— */}
                    <nav className="bg-white sticky top-0 z-40 border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-xl text-white">
                                <Users size={24} />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-slate-800">TBC Service Manager</h1>
                            </div>
                        </div>
                        <button onClick={openAddModal} className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-xl flex items-center gap-2 shadow-sm transition-all active:scale-95">
                            <UserPlus size={18} /> <span className="hidden sm:inline">æ–°å¢åŒå·¥</span>
                        </button>
                    </nav>

                    {/* æç¤ºè¨Šæ¯ (ä¿®æ­£ z-index ç‚º z-[60] ç¢ºä¿é¡¯ç¤ºåœ¨ Modal ä¹‹ä¸Š) */}
                    {message.text && (
                        <div className={`fixed top-20 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full font-bold shadow-lg animate-fade-in flex items-center gap-2 ${message.type === 'success' ? 'bg-emerald-500 text-white' : 'bg-red-500 text-white'}`}>
                            {message.type === 'success' ? <CheckCircle2 size={18}/> : <AlertCircle size={18}/>}
                            {message.text}
                        </div>
                    )}

                    <main className="flex-grow p-6 max-w-6xl mx-auto w-full">
                        {/* æœå°‹åˆ— */}
                        <div className="bg-white p-2 rounded-2xl shadow-sm border border-slate-200 mb-6 flex items-center relative">
                            <Search className="absolute left-6 text-slate-400" size={20} />
                            <input 
                                type="text" 
                                placeholder="æœå°‹å§“åæˆ–ç¾¤çµ„ (ä¾‹å¦‚: FA)..." 
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                                className="w-full pl-12 pr-4 py-3 bg-transparent outline-none font-bold text-slate-700"
                            />
                        </div>

                        {/* åŒå·¥åˆ—è¡¨ (å¡ç‰‡ç¶²æ ¼) */}
                        {isLoading && members.length === 0 ? (
                            <div className="text-center py-20 text-slate-400 font-bold animate-pulse">è¼‰å…¥è³‡æ–™åº«ä¸­...</div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {filteredMembers.map(member => {
                                    const ownedPosList = memberPositions
                                        .filter(mp => mp.member_id === member.id)
                                        .map(mp => {
                                            const p = positions.find(pos => pos.id === mp.position_id);
                                            return p ? { name: p.name, isActive: mp.is_active !== false } : null;
                                        })
                                        .filter(Boolean);

                                    return (
                                        <div key={member.id} className="bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-200 hover:shadow-md transition-shadow">
                                            <div className="flex justify-between items-start mb-4">
                                                <div className="flex items-center gap-3">
                                                    <div>
                                                        <h3 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                                            {member.name}
                                                            {member.group_id && <span className="text-[10px] bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded border border-indigo-100">{member.group_id}</span>}
                                                        </h3>
                                                        <div className="flex items-center gap-1 text-xs font-bold mt-1">
                                                            <span className={member.availability_status === 'ç©©å®šæœäº‹' ? 'text-emerald-500' : 'text-orange-500'}>â— {member.availability_status}</span>
                                                            <span className="text-slate-300">|</span>
                                                            <span className="text-slate-500">{member.preferred_session}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => openEditModal(member)} className="p-2 bg-slate-50 hover:bg-indigo-50 text-slate-400 hover:text-indigo-600 rounded-lg transition-colors"><Edit2 size={16}/></button>
                                                    <button onClick={() => handleDelete(member.id, member.name)} className="p-2 bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-600 rounded-lg transition-colors"><Trash2 size={16}/></button>
                                                </div>
                                            </div>

                                            <div className="space-y-3">
                                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                    <p className="text-[10px] font-bold text-slate-400 mb-1 flex items-center gap-1"><ShieldCheck size={12}/> æœäº‹è³‡æ ¼ ({ownedPosList.length})</p>
                                                    <div className="flex flex-wrap gap-1">
                                                        {ownedPosList.length > 0 ? ownedPosList.map(p => (
                                                            <span key={p.name} className={`text-[10px] font-bold px-2 py-1 rounded-md border ${p.isActive ? 'bg-white border-slate-200 text-slate-600' : 'bg-slate-50 border-slate-200 border-dashed text-slate-400'}`}>
                                                                {p.name} {!p.isActive && <span className="text-slate-400">(æš«åœ)</span>}
                                                            </span>
                                                        )) : <span className="text-xs text-slate-400">å°šæœªè¨­å®š</span>}
                                                    </div>
                                                </div>
                                                
                                                {(member.unavailable_dates && member.unavailable_dates.length > 0) && (
                                                    <div className="bg-orange-50/50 p-3 rounded-xl border border-orange-100">
                                                        <p className="text-[10px] font-bold text-orange-400 mb-1 flex items-center gap-1"><CalendarX size={12}/> è«‹å‡æ—¥æœŸ ({member.unavailable_dates.length})</p>
                                                        <div className="flex flex-wrap gap-1">
                                                            {member.unavailable_dates.map(d => (
                                                                <span key={d} className="text-[10px] font-bold bg-white text-orange-600 px-1.5 py-0.5 rounded border border-orange-200">{d}</span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        
                        {!isLoading && filteredMembers.length === 0 && (
                            <div className="text-center py-20 text-slate-400 font-bold">æ‰¾ä¸åˆ°ç¬¦åˆçš„åŒå·¥è³‡æ–™</div>
                        )}
                    </main>

                    {/* æ–°å¢/ç·¨è¼¯ Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm animate-fade-in overflow-y-auto">
                            <div className="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden my-auto max-h-[90vh] flex flex-col">
                                <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                                    <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                                        {editingMember ? <Edit2 size={20} className="text-indigo-600"/> : <UserPlus size={20} className="text-indigo-600"/>}
                                        {editingMember ? 'ç·¨è¼¯åŒå·¥è³‡æ–™' : 'æ–°å¢åŒå·¥'}
                                    </h2>
                                    <button onClick={closeModal} className="p-2 hover:bg-slate-200 rounded-full text-slate-500 transition-colors"><X size={20}/></button>
                                </div>
                                
                                <div className="p-6 space-y-6 overflow-y-auto">
                                    {/* åŸºæœ¬è³‡æ–™å€å¡Š */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">å§“å <span className="text-red-500">*</span></label>
                                            <input 
                                                type="text" 
                                                value={formData.name} 
                                                onChange={e => setFormData({...formData, name: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700"
                                                placeholder="è«‹è¼¸å…¥å§“å"
                                            />
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">ç¾¤çµ„ ID<span className="text-slate-400 font-normal">(é¸å¡«)</span></label>
                                            <input 
                                                type="text" 
                                                value={formData.group_id} 
                                                onChange={e => setFormData({...formData, group_id: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 uppercase"
                                                placeholder="ä¾‹å¦‚ï¼šFAã€FB"
                                            />
                                            {existingGroupIds.length > 0 && (
                                                <p className="text-[10px] text-slate-400 font-semibold leading-relaxed">
                                                    ç¾æœ‰ç¾¤çµ„ï¼š<span className="text-indigo-400">{existingGroupIds.join(', ')}</span>
                                                </p>
                                            )}
                                        </div>
                                    </div>

                                    {/* æ„é¡˜èˆ‡ç‹€æ…‹å€å¡Š */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">æœäº‹æ„é¡˜</label>
                                            <select 
                                                value={formData.availability_status} 
                                                onChange={e => setFormData({...formData, availability_status: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 cursor-pointer"
                                            >
                                                {STATUS_OPTIONS.map(opt => (
                                                    <option key={opt} value={opt}>{opt}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="space-y-2">
                                            <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">åå¥½å ‚åˆ¥</label>
                                            <select 
                                                value={formData.preferred_session} 
                                                onChange={e => setFormData({...formData, preferred_session: e.target.value})} 
                                                className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 cursor-pointer"
                                            >
                                                {SESSION_OPTIONS.map(opt => (
                                                    <option key={opt} value={opt}>{opt}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider">åŒæ—¥äºŒå ‚æœäº‹</label>
                                        <select 
                                            value={formData.dual_service_pref} 
                                            onChange={e => setFormData({...formData, dual_service_pref: e.target.value})} 
                                            className="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-100 transition-all font-semibold text-slate-700 cursor-pointer"
                                        >
                                            <option value="0">ç„¡</option>
                                            <option value="1">åŒå´—ä½</option>
                                            <option value="2">ä¸åŒå´—ä½</option>
                                        </select>
                                    </div>

                                    {/* æœäº‹è³‡æ ¼é¸æ“‡ */}
                                    <div className="pt-4 border-t border-slate-100">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5 mb-1">
                                            <ShieldCheck size={16} className="text-indigo-500"/> æœäº‹å´—ä½è³‡æ ¼
                                        </label>
                                        <p className="text-[10px] text-slate-400 mb-3 ml-5">æç¤ºï¼šé€£çºŒé»æ“ŠæŒ‰éˆ•å¯åˆ‡æ›ã€Œæ­£å¸¸ã€æˆ–ã€Œæš«åœã€ç‹€æ…‹</p>
                                        <div className="flex flex-wrap gap-2">
                                            {positions.length === 0 && <span className="text-sm text-slate-400">ç³»çµ±å°šæœªå»ºç«‹å´—ä½è³‡æ–™ã€‚</span>}
                                            {positions.map(pos => {
                                                const status = formPositions[pos.id];
                                                
                                                // ç„¡è³‡æ ¼ (æœªé¸å–) - æ·ºç°åº•è‰²ã€æ·ºç°å­—
                                                let btnStyle = 'bg-slate-100 border-slate-100 text-slate-400 hover:bg-slate-200'; 
                                                
                                                if (status === 'active') {
                                                    // æœ‰è³‡æ ¼ä¸”æ­£å¸¸
                                                    btnStyle = 'bg-indigo-50 border-indigo-500 text-indigo-700 shadow-sm';
                                                } else if (status === 'inactive') {
                                                    // æœ‰è³‡æ ¼ä½†æš«åœ
                                                    btnStyle = 'bg-white border-slate-400 text-slate-600 border-dashed shadow-sm';
                                                }
                                                
                                                return (
                                                    <button
                                                        key={pos.id}
                                                        onClick={() => togglePosition(pos.id)}
                                                        className={`px-3 py-2 rounded-xl text-sm font-bold transition-all border-2 flex items-center gap-1.5 ${btnStyle}`}
                                                    >
                                                        {pos.name}
                                                        {status === 'active' && <span className="text-[10px] bg-indigo-100 text-indigo-600 px-1.5 py-0.5 rounded">æ­£å¸¸</span>}
                                                        {status === 'inactive' && <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">æš«åœ</span>}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>

                                    {/* è«‹å‡æ—¥æœŸè¨­å®š */}
                                    <div className="pt-4 border-t border-slate-100 pb-2">
                                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1.5 mb-3">
                                            <CalendarX size={16} className="text-orange-500"/> è«‹å‡ / ä¸å¯æ’ç­æ—¥æœŸ
                                        </label>
                                        <div className="flex gap-2 mb-3">
                                            <input 
                                                type="date" 
                                                value={newDateInput} 
                                                onChange={e => setNewDateInput(e.target.value)} 
                                                className="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 outline-none focus:border-orange-400 focus:ring-2 focus:ring-orange-100 transition-all font-semibold text-slate-700"
                                            />
                                            <button 
                                                onClick={addUnavailableDate} 
                                                className="bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold px-4 py-2.5 rounded-xl transition-colors active:scale-95"
                                            >
                                                åŠ å…¥æ—¥æœŸ
                                            </button>
                                        </div>
                                        
                                        <div className="flex flex-wrap gap-2">
                                            {formData.unavailable_dates.length === 0 && <span className="text-sm text-slate-400">ç›®å‰ç„¡è«‹å‡ç´€éŒ„ã€‚</span>}
                                            {formData.unavailable_dates.map(date => (
                                                <div key={date} className="bg-white border border-orange-200 text-orange-600 pl-3 pr-1 py-1.5 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm">
                                                    {date}
                                                    <button 
                                                        onClick={() => removeUnavailableDate(date)} 
                                                        className="p-1 hover:bg-orange-100 rounded-md text-orange-400 hover:text-orange-700 transition-colors"
                                                    >
                                                        <X size={14}/>
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                {/* åº•éƒ¨æŒ‰éˆ•å€ */}
                                <div className="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                                    <button 
                                        onClick={closeModal} 
                                        className="px-5 py-2.5 rounded-xl font-bold text-slate-600 hover:bg-slate-200 transition-colors"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        onClick={handleSave} 
                                        disabled={isLoading} 
                                        className="bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-md transition-all active:scale-95"
                                    >
                                        <Save size={18}/> 
                                        {isLoading ? 'å„²å­˜ä¸­...' : 'å„²å­˜è¨­å®š'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
